<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KDJ PEPE/USDT Realtime (Custom TF)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: 'Segoe UI', Roboto, sans-serif; padding: 1rem; background: #0d1117; color: #c9d1d9; }
.card { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.5); }
select, button, input[type=checkbox] { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; border-radius: 6px; padding: 0.3rem 0.6rem; }
button:hover, select:hover { background: #30363d; cursor: pointer; }
canvas { background: #0d1117; }
</style>
</head>
<body>
<div class="card">
  <label>Pilih Timeframe:
    <select id="timeframe">
      <option value="1m">1m</option>
      <option value="5m">5m</option>
      <option value="15m" selected>15m</option>
      <option value="4h">4h</option>
    </select>
  </label>
  <label style="margin-left:1rem;">
    <input type="checkbox" id="muteToggle"> Matikan bunyi
  </label>
  <button id="testBeep" style="margin-left:1rem;">Test Bunyi</button>
  <div style="margin-top:0.5rem;">Harga Terkini: <span id="livePrice">—</span> USDT</div>
</div>
<canvas id="chart" height="280"></canvas>
<div id="info" style="margin-top:1rem;"></div>
<script>
let audioEnabled = true;
let audioCtx;
let beepInterval = null;
function beep(durationMs=200,freq=880){
  if(!audioEnabled)return;
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.type='sine';o.frequency.value=freq;o.connect(g);g.connect(audioCtx.destination);
  const now=audioCtx.currentTime;
  g.gain.setValueAtTime(0.001,now);
  g.gain.exponentialRampToValueAtTime(0.2,now+0.01);
  g.gain.exponentialRampToValueAtTime(0.001,now+durationMs/1000);
  o.start();o.stop(now+durationMs/1000);
}
function startBeepLoop(){
  if(beepInterval) return;
  beepInterval = setInterval(()=>beep(), 500);
}
function stopBeepLoop(){
  if(beepInterval){
    clearInterval(beepInterval);
    beepInterval = null;
  }
}
function computeKDJ(highs,lows,closes,n=9){
  const rsv=Array(closes.length).fill(null);
  for(let i=0;i<closes.length;i++){
    if(i<n-1)continue;
    let hh=-Infinity,ll=Infinity;
    for(let j=i-n+1;j<=i;j++){
      hh=Math.max(hh,highs[j]);
      ll=Math.min(ll,lows[j]);
    }
    const denom=hh-ll;
    rsv[i]=denom===0?0:((closes[i]-ll)/denom)*100;
  }
  const K=Array(closes.length).fill(null);
  const D=Array(closes.length).fill(null);
  const J=Array(closes.length).fill(null);
  let kPrev=50,dPrev=50;
  for(let i=0;i<closes.length;i++){
    if(rsv[i]==null)continue;
    const k=(2/3)*kPrev+(1/3)*rsv[i];
    const d=(2/3)*dPrev+(1/3)*k;
    const j=3*k-2*d;
    K[i]=k;D[i]=d;J[i]=j;kPrev=k;dPrev=d;
  }
  return {K,D,J};
}
function detectCross(pk,pd,ck,cd){
  if(pk==null||pd==null||ck==null||cd==null)return null;
  if(pk< pd && ck>cd) return 'bull';
  if(pk> pd && ck<cd) return 'bear';
  return null;
}
async function fetchKlines(tf,limit=200){
  const url=`https://api.binance.com/api/v3/klines?symbol=PEPEUSDT&interval=${tf}&limit=${limit}`;
  const res=await fetch(url);const data=await res.json();
  return {
    openTime:data.map(d=>d[0]),
    highs:data.map(d=>+d[2]),
    lows:data.map(d=>+d[3]),
    closes:data.map(d=>+d[4])
  };
}
function tsLabel(ts){return new Date(ts).toLocaleString();}
let chart;
let lastCrossState = null;
async function buildChart(tf){
  const {openTime,highs,lows,closes}=await fetchKlines(tf);
  const {K,D,J}=computeKDJ(highs,lows,closes);
  const labels=openTime.map(tsLabel);
  if(chart)chart.destroy();
  chart=new Chart(document.getElementById('chart').getContext('2d'),{
    type:'line',
    data:{labels,datasets:[
      {label:'K',data:K,borderColor:'#58a6ff',pointRadius:0},
      {label:'D',data:D,borderColor:'#f78166',pointRadius:0},
      {label:'J',data:J,borderColor:'#3fb950',borderDash:[5,5],pointRadius:0}
    ]},
    options:{animation:false,plugins:{legend:{labels:{color:'#c9d1d9'}}},scales:{x:{ticks:{color:'#8b949e'}},y:{ticks:{color:'#8b949e'}}}}
  });
  const last=K.length-1;
  const cross=detectCross(K[last-1],D[last-1],K[last],D[last]);
  const info=document.getElementById('info');
  info.textContent=`K:${K[last]?.toFixed(2)} D:${D[last]?.toFixed(2)} J:${J[last]?.toFixed(2)} Sinyal:${cross||'—'}`;
  if(cross){
    if(lastCrossState!==cross){
      lastCrossState = cross;
      startBeepLoop();
    }
  } else {
    lastCrossState = null;
    stopBeepLoop();
  }
}
function startPriceWS(){
  const priceEl=document.getElementById('livePrice');
  const ws=new WebSocket('wss://stream.binance.com:9443/ws/pepeusdt@trade');
  ws.onmessage=(ev)=>{const msg=JSON.parse(ev.data);if(msg.p)priceEl.textContent=parseFloat(msg.p).toLocaleString(undefined,{maximumFractionDigits:10});};
  ws.onclose=()=>setTimeout(startPriceWS,3000);
}
document.getElementById('timeframe').addEventListener('change',e=>buildChart(e.target.value));
document.getElementById('muteToggle').addEventListener('change',e=>{audioEnabled=!e.target.checked; if(!audioEnabled) stopBeepLoop();});
document.getElementById('testBeep').addEventListener('click',()=>{beep();});
startPriceWS();
buildChart(document.getElementById('timeframe').value);
setInterval(()=>buildChart(document.getElementById('timeframe').value),30000);
</script>
</body>
</html>
