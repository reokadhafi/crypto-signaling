<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KDJ PEPE/USDT Realtime</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #fff;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .card {
      background: #1e1e1e;
      padding: 1rem;
      border-radius: 1rem;
      margin: 1rem;
      width: 95%;
      max-width: 600px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    select, button {
      padding: 0.4rem 0.8rem;
      border-radius: 0.5rem;
      border: none;
      font-size: 0.9rem;
    }
    button { cursor: pointer; }
    #price { margin-top: 0.5rem; font-size: 1rem; }
    #info {
      margin-top: 0.5rem;
      font-size: 1rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
    .infoBox {
      padding: 0.3rem 0.6rem;
      border-radius: 0.3rem;
      font-weight: bold;
      color: #fff;
    }
    .infoK { background: blue; }
    .infoD { background: orange; }
    .infoJ { background: green; }
    #signalBox {
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 1.5rem;
      font-weight: bold;
      border-radius: 0.5rem;
      display: none;
      animation: blink 1s infinite;
      text-align: center;
    }
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0; }
      100% { opacity: 1; }
    }
    .chart-container { position: relative; height: 300px; }
    canvas { max-width: 100%; }
  </style>
</head>
<body>
  <div class="card">
    <div class="controls">
      <label for="timeframe">Pilih Timeframe:</label>
      <select id="timeframe">
        <option value="1m">1m</option>
        <option value="5m">5m</option>
        <option value="15m" selected>15m</option>
        <option value="1h">1h</option>
        <option value="4h">4h</option>
        <option value="1d">1d</option>
      </select>
      <button id="muteToggle">ðŸ”Š</button>
      <button id="testBeep">Test Bunyi</button>
    </div>
    <div id="price">Harga Terkini: -</div>
    <div class="chart-container">
      <canvas id="chart"></canvas>
    </div>
    <div id="info"></div>
    <div id="signalBox"></div>
  </div>

  <script>
    const ctx = document.getElementById('chart').getContext('2d');
    let chart;

    // Audio
    let audioCtx;
    let beepInterval;
    let audioEnabled = true;
    function startBeepLoop() {
      if (!audioEnabled || beepInterval) return;
      beepInterval = setInterval(() => beep(), 500);
    }
    function stopBeepLoop() {
      if (beepInterval) {
        clearInterval(beepInterval);
        beepInterval = null;
      }
    }
    function beep() {
      if (!audioEnabled) return;
      if (!audioCtx || audioCtx.state === 'closed') {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      const oscillator = audioCtx.createOscillator();
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime);
      oscillator.connect(audioCtx.destination);
      oscillator.start();
      oscillator.stop(audioCtx.currentTime + 0.1);
    }
    document.getElementById('testBeep').onclick = () => beep();
    document.getElementById('muteToggle').onclick = () => {
      audioEnabled = !audioEnabled;
      document.getElementById('muteToggle').textContent = audioEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
      if (!audioEnabled) stopBeepLoop();
      else if (currentSignal !== null) startBeepLoop();
    };

    let currentSignal = null;

    async function fetchKlines(tf) {
      const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=PEPEUSDT&interval=${tf}&limit=50`);
      return res.json();
    }

    function calculateKDJ(data) {
      let RSV = [], K = [], D = [], J = [];
      let n = 9;
      let prevK = 50, prevD = 50;
      for (let i = 0; i < data.length; i++) {
        if (i < n) {
          RSV.push(null); K.push(null); D.push(null); J.push(null);
          continue;
        }
        let slice = data.slice(i - n, i);
        let low = Math.min(...slice.map(d => parseFloat(d[3])));
        let high = Math.max(...slice.map(d => parseFloat(d[2])));
        let close = parseFloat(data[i][4]);
        let rsv = ((close - low) / (high - low)) * 100;
        RSV.push(rsv);

        prevK = (2/3 * prevK) + (1/3 * rsv);
        prevD = (2/3 * prevD) + (1/3 * prevK);

        K.push(prevK);
        D.push(prevD);
        J.push(3*prevK - 2*prevD);
      }
      return {K,D,J};
    }

    async function updateChart(tf) {
      const data = await fetchKlines(tf);
      const {K,D,J} = calculateKDJ(data);
      const labels = data.map((_,i) => i + 1);
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {label: 'K', data: K, borderColor: 'blue', borderWidth: 2, fill:false, pointRadius:0},
            {label: 'D', data: D, borderColor: 'orange', borderWidth: 2, fill:false, pointRadius:0},
            {label: 'J', data: J, borderColor: 'green', borderWidth: 2, borderDash: [5,5], fill:false, pointRadius:0},
            {label: 'Overbought', data: Array(labels.length).fill(80), borderColor: 'gray', borderWidth: 1, borderDash: [2,2], pointRadius:0},
            {label: 'Oversold', data: Array(labels.length).fill(20), borderColor: 'gray', borderWidth: 1, borderDash: [2,2], pointRadius:0}
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: { color: '#fff', font: {size: 10} }
            }
          },
          scales: {
            x: { ticks: { display: false }, grid:{display:false} },
            y: { min:0, max:100, ticks: { color:'#fff' } }
          }
        }
      });

      let signalBox = document.getElementById('signalBox');
      let info = document.getElementById('info');
      let lastK = K[K.length-1], prevK = K[K.length-2];
      let lastD = D[D.length-1], prevD = D[D.length-2];
      let signal = null;
      if (prevK < prevD && lastK > lastD) signal = 'BUY';
      if (prevK > prevD && lastK < lastD) signal = 'SELL';

      if (signal) {
        signalBox.style.display = 'block';
        signalBox.textContent = signal;
        signalBox.style.background = signal === 'BUY' ? 'green' : 'red';
        currentSignal = signal;
        if (audioEnabled) startBeepLoop();
      } else {
        signalBox.style.display = 'none';
        stopBeepLoop();
        currentSignal = null;
      }

      info.innerHTML = `
        <span class="infoBox infoK">K: ${lastK?.toFixed(2)}</span>
        <span class="infoBox infoD">D: ${lastD?.toFixed(2)}</span>
        <span class="infoBox infoJ">J: ${J[J.length-1]?.toFixed(2)}</span>
      `;
    }

    // harga realtime
    let priceEl = document.getElementById('price');
    const ws = new WebSocket('wss://stream.binance.com:9443/ws/pepeusdt@trade');
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      priceEl.textContent = 'Harga Terkini: ' + parseFloat(data.p).toFixed(8) + ' USDT';
    };

    // ganti timeframe manual
    document.getElementById('timeframe').onchange = (e) => {
      const tf = e.target.value;
      updateChart(tf);
    };

    // pertama kali jalan
    let currentTF = '15m';
    updateChart(currentTF);

    // auto update tiap 30 detik
    setInterval(() => {
      currentTF = document.getElementById('timeframe').value;
      updateChart(currentTF);
    }, 30000);
  </script>
</body>
</html>
